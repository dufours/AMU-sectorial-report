---
title: "Organisation des jeux de données"
author: "Simon Dufour"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_float: true
  

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Organisation des jeux de données pour le prototype de rapport comparatif
Ce script servira à organiser / explorer les jeux de données qui seront plus tard utilisés pour créer le prototype de rapport sectoriel.  Aussi, les figures et tables qui seraient présentées seront esquissées dans un autre script.
  
D'abbord, nous pouvons importer et regrouper les jeux de données (n=3) contenant les ventes vétérinaires 2016-2018, 2019 et 2020. Le jeu de données 2016-2018 contient en fait les données de janvier 2016 à fin février 2019. Le jeu 2020 contenait janvier 2020 à fin décembre 2020. Le jeu 2019 est un jeu de données fictif, ce sont les données mars à décembre 2020, recodées de tel sorte que ce semble être les données de la même période en 2019 (i.e., date=date-365).  
    
Ces fichiers de ventes vétérinaires ont été générées à partir d'une extraction des données Vet expert. Le script C# `ExecutablesV3.3` a été utilisé avec la table de conversion `Conversion_Table_2022-05-12.xlsx` afin d'identifier les antibiotiques et de calculer les g, DDD et DCD. La qualité de la table de conversion à été vérifiée à l'aide d'une recherche des unités de ventes non-codées. Un certains nombre de lignes correspondant à des antibiotiques, mais pour lesquelles la quantité est impossible à déterminer (e.g., 2 doses) ne sont pas transformées en g, DDD et DCD. Leur nombre exact pourra être compilé plus loin.  
  
Pour le moment, toutes les lignes de ventes (antibiotiques ou non) on été conservées.

```{r}
v1 <- read.csv(file="data/Ventes vet2016-2018Out.csv", header=TRUE, sep=";", encoding="UTF-8")

v2 <- read.csv(file="data/Ventes vet2019Out.csv", header=TRUE, sep=";", encoding="UTF-8")

v3 <- read.csv(file="data/Ventes vet2020Out.csv", header=TRUE, sep=";", encoding="UTF-8")


data <- rbind(v1, v2, v3)

```
  
Ensuite, on devra assigner les numéros de fermes dans la base de données contenant les ventes d'antibiotiques en se basant sur les identifications de fermes. Pour ça, nous devons importer la table qui contient les liens entres les NIM et numéros de projets. Ici, nous gardons cette partie du script "cachée" afin d'éviter les bris de confidentialité. Nous avons aussi déjà exclu une première ferme (ferme #88) qui avait un problème majeur lors de l'extraction des données 2016-2018 (problème Sysvet de mémoire).  
  
```{r, echo=FALSE, results=FALSE, fig.cap="Nombre de lignes de ventes **totales** par ferme."}
#options(scipen=999)
#tapply(data$Nim.Client, data$Nom.Client, summary)

id <- read.csv(file="data/Farm_ID.csv", header=TRUE, sep=";", encoding="UTF-8")

#Main merge
data2 <- merge(
  x = data,
  y = id,
  by.x = "Nim.Client",
  by.y = "NIM1",
  all.x=TRUE
)

#Merge of the 6 farms with a second and/or third NIM
data2$No.ferme <- ifelse(data2$Nim.Client=="100312255" | data2$Nim.Client=="101231595", 49,
                         ifelse(data2$Nim.Client=="101266427", 59,
                                ifelse(data2$Nim.Client=="100172620" | data2$Nim.Client=="100172631", 86, 
                                       ifelse(data2$Nim.Client=="100479476", 8,
                                              ifelse(data2$Nim.Client=="100450501", 14,
                                                     ifelse(data2$Nim.Client=="100040211", 29, data2$No.ferme))))))

#Il y a la ferme 88 (A Lestage) qui a le gros problème de répétition de lignes, il faut l'exclure 
data3 <- subset(data2, No.ferme!=88)


library(summarytools)
print(dfSummary(data3$No.ferme), method='render')
print(dfSummary(data3$Nim.Client), method='render')

library(ggplot2)
ggplot(data=data3, mapping=(aes(x=No.ferme))) +
  geom_bar()+
  theme_bw()

#Maintenant, retirer les champs permettant d'identifier les producteurs
myvars <- names(data3) %in% c("Nim.Client", "Nom.Client", "Clinique", "Vet", "Nim.Client2", "Nim.Client3", "NIM2", "NIM3")
data4 <- data3[!myvars]
#Reorder variables
data5 <- data4[, c(98, 1:97)]

```
   
Nous devons maintenant identifier / retirer les 15 à 20 fermes qui n'étaient plus suivies en 2019 ou 2020.
```{r}
#Extract year
data5$Year <- factor(substr(data5$Date, 1, 4))
summary(data5$Year)
data5 <- data5[, c(1, 99, 2:98)]

data5$No.ferme <- factor(data5$No.ferme)
```

```{r}
#library(gmodels)
#CrossTable(data5$No.ferme, data5$Year, prop.t=FALSE, prop.r=FALSE, prop.c=FALSE)

```
  
Il y aurait 16 fermes qui n'étaient plus suivies en 2020: 1, 12, 14, 15, 21, 23, 24, 28, 31, 32, 48, 57, 69, 73, 83, 102. Nous les retirons:
```{r}
Ventes <- subset(data5, (No.ferme!=1 & No.ferme!=12 & No.ferme!=14 & No.ferme!=15 & No.ferme!=21 & No.ferme!=23 & No.ferme!=24 & No.ferme!=28 & No.ferme!=31 & No.ferme!=32 & No.ferme!=48 & No.ferme!=57 & No.ferme!=69 & No.ferme!=73 & No.ferme!=83 & No.ferme!=102))
```

Finalement, on peut vérifier le nombre de ligne de vente totales et de ventes d'antibiotiques en particulier.   
```{r}
num_vente <- dim(Ventes)

AMU <- subset(Ventes, TYPE_PRODUIT==1)
num_amu <- dim(AMU)

prop <- round(num_amu[1]/num_vente[1]*100, digits=1)

uncodable <- subset(AMU, ROUTE==0) 
unc <- dim(uncodable)
prop2 <- round(unc/num_amu*100, digits=1)

```
Il y avait donc `r num_vente[1]` lignes de ventes, dont `r num_amu[1]` (`r prop`%) était des antibiotiques. Parmis ceux-ci, il y avait `r unc[1]` (`r prop2[1]`%) produits antibiotiques pour lesquels il était impossible de déterminer la quantité exacte. Ce sont souvent des  unités de mesures pour lesquelles il est impossible de déterminer un nombre exact de ml, g, bolus, ou tube (ex: 1 "dose").  
  
Voici le nombre de vente d'antibiotiques par ferme:  
  
```{r, fig.cap="Nombre de lignes de ventes **d'antibiotiques** par ferme."}
library(ggplot2)
ggplot(data=AMU, mapping=(aes(x=No.ferme))) +
  geom_bar()+
  coord_flip()+
  theme_bw()
```
  
Maintenant que cette compilation est faite, nous devrons **retirer les lignes d'antibiotiques pour lesquels on ne peut calculer une quantité exacte**.  
  
```{r}
AMU <- subset(AMU, ROUTE!=0)
dim(AMU)
```
  
À partir d'ici, il faudra additionner, par année et pour chaque ferme la quantité d'antibiotique utilisé. **Voici quelques décisions qui ont été prises en groupe:**  
  
- On pourrait laisser aux lecteurs le choix de l'unité utilisée pour lire le rapport. Nouys avons décidé de laisser le choix aux lecteurs entre DCDbovCA (traitements standardisés) et DDDbovCA (dose journalière). 
    
- On pourrait d'office présenter une figure sur l'**utilisation totale** et 3 figures présentant l'**utilisation par catégories** (I, II et III seulement). Pour les catégorie IV, il s'agit principalement du Monensin et du Lasalocide sodique. Pour l'instant, le Monensin se retrouve surtout dans les aliments (prescriptions alimentaires) et un peu dans les ventes (bolus). La compilation du Monensin dans les données de ventes est donc parcellaire. Le lasalocide sodique sera presque entièrement dans les données de prescriptions alimentaires. Je crois donc qu'il faut éviter de compiler les catégories IV et, surtout, de les compiler dans le total (puisque ce sera incomplet). Étant donné leur faible importance, c'est beaucoup plus simple, à ce stade. de les exclure des calculs.  
  
- Une figure **par voie d'administration** sera également disponible, de même que des figures par **familles d'antibiotiques** et **par molécule**. 
  
- Au dénominateur, nous standardiserons les taux d'AMU par nombre de vaches adultes (lactation + taries).  
  
- La novobiocine n'est pas présentement catégorisée par Santé Canada. Aussi, les produits bovins contenant de la novobiocine ont tous été discontinués. Cette molécule ne sera donc pas compilée dans le rapport.  
  
- Techniquement, ce serait plus simple de compiler les indices par ferme, par année ici, puis de générer et sauvegarder les figures. Le script pour l'interface aura alors seulement à "appeller" les bonnes figures et sera alors plus rapide (i.e., plus réactif). Sinon, avec une base de données complète, et/ou la génération des figures dans l'interface, l'interface pourrait être lente.

## Calculs des indices pré-interface
Je vais donc déjà calculer les différents indices d'intérêt dans les lignes suivantes.

###
```{r}
#First summarize by farm, year and administration route. This will be the table with the maximum possibilities in term of exploding the data.
Agg.amu <- setNames(
  aggregate(
    cbind(AMU$TYLOSIN_DCD, 
          AMU$CHLORTETRACYCLINE_DCD, 
          AMU$BENZYLPENICILLIN_P_DCD, 
          AMU$DIHYDROSTREPTOMYCIN_DCD, 
          AMU$POLYMYXINB_SULF_DCD, 
          AMU$CEFAPIRIN_DCD, 
          AMU$PIRLIMYCIN_DCD, 
          AMU$CEFTIOFUR_DCD, 
          AMU$CLOXACILLIN_DCD, 
          AMU$TRIM_SULFADOXINE_DCD, 
          AMU$OXYTETRACYCLINE_DCD, 
          AMU$AMPICILLIN_DCD, 
          AMU$TILMICOSIN_DCD, 
          AMU$BENZYLPENICILLIN_B_DCD, 
          AMU$ENROFLOXACIN_DCD, 
          AMU$DANOFLOXACIN_DCD, 
          AMU$TULATHROMYCIN_DCD, 
          AMU$GAMITROMYCIN_DCD, 
          AMU$TILDIPIROSIN_DCD, 
          AMU$MARBOFLOXACIN_DCD, 
          AMU$SULFANILAMIDE_DCD, 
          AMU$SULFATHIAZOLE_DCD, 
          AMU$STREPTOMYCIN_SULF_DCD, 
          AMU$SULFAMETHAZINE_DCD, 
          AMU$TETRACYCLINE_DCD, 
          AMU$NEOMYCIN_SULF_DCD, 
          AMU$SULFAMERAZINE_DCD, 
          AMU$SULFAGUANIDINE_DCD, 
          AMU$SUCCINYLSULFATHIAZOLE_DCD,
          AMU$FLORFENICOL_DCD,
         
          AMU$TYLOSIN_DDD, 
          AMU$CHLORTETRACYCLINE_DDD, 
          AMU$BENZYLPENICILLIN_P_DDD, 
          AMU$DIHYDROSTREPTOMYCIN_DDD, 
          AMU$POLYMYXINB_SULF_DDD, 
          AMU$CEFAPIRIN_DDD, 
          AMU$PIRLIMYCIN_DDD, 
          AMU$CEFTIOFUR_DDD, 
          AMU$CLOXACILLIN_DDD, 
          AMU$TRIM_SULFADOXINE_DDD, 
          AMU$OXYTETRACYCLINE_DDD, 
          AMU$AMPICILLIN_DDD, 
          AMU$TILMICOSIN_DDD, 
          AMU$BENZYLPENICILLIN_B_DDD, 
          AMU$ENROFLOXACIN_DDD, 
          AMU$DANOFLOXACIN_DDD, 
          AMU$TULATHROMYCIN_DDD, 
          AMU$GAMITROMYCIN_DDD, 
          AMU$TILDIPIROSIN_DDD, 
          AMU$MARBOFLOXACIN_DDD, 
          AMU$SULFANILAMIDE_DDD, 
          AMU$SULFATHIAZOLE_DDD, 
          AMU$STREPTOMYCIN_SULF_DDD, 
          AMU$SULFAMETHAZINE_DDD, 
          AMU$TETRACYCLINE_DDD, 
          AMU$NEOMYCIN_SULF_DDD, 
          AMU$SULFAMERAZINE_DDD, 
          AMU$SULFAGUANIDINE_DDD, 
          AMU$SUCCINYLSULFATHIAZOLE_DDD,
          AMU$FLORFENICOL_DDD
          ), 
    by=list(AMU$Year, AMU$No.ferme, AMU$ROUTE), FUN=sum),
  c( "Year",
     "No.Ferme",
     "Route",
     "TYLOSIN_DCD",
     "CHLORTETRACYCLINE_DCD",
     "BENZYLPENICILLIN_P_DCD", 
     "DIHYDROSTREPTOMYCIN_DCD", 
     "POLYMYXINB_SULF_DCD", 
     "CEFAPIRIN_DCD", 
     "PIRLIMYCIN_DCD", 
     "CEFTIOFUR_DCD", 
     "CLOXACILLIN_DCD", 
     "TRIM_SULFADOXINE_DCD", 
     "OXYTETRACYCLINE_DCD", 
     "AMPICILLIN_DCD", 
     "TILMICOSIN_DCD", 
     "BENZYLPENICILLIN_B_DCD", 
     "ENROFLOXACIN_DCD", 
     "DANOFLOXACIN_DCD", 
     "TULATHROMYCIN_DCD", 
     "GAMITROMYCIN_DCD", 
     "TILDIPIROSIN_DCD", 
     "MARBOFLOXACIN_DCD", 
     "SULFANILAMIDE_DCD", 
     "SULFATHIAZOLE_DCD", 
     "STREPTOMYCIN_SULF_DCD", 
     "SULFAMETHAZINE_DCD", 
     "TETRACYCLINE_DCD", 
     "NEOMYCIN_SULF_DCD", 
     "SULFAMERAZINE_DCD", 
     "SULFAGUANIDINE_DCD", 
     "SUCCINYLSULFATHIAZOLE_DCD",
     "FLORFENICOL_DCD",
     
     "TYLOSIN_DDD",
     "CHLORTETRACYCLINE_DDD",
     "BENZYLPENICILLIN_P_DDD", 
     "DIHYDROSTREPTOMYCIN_DDD", 
     "POLYMYXINB_SULF_DDD", 
     "CEFAPIRIN_DDD", 
     "PIRLIMYCIN_DDD", 
     "CEFTIOFUR_DDD", 
     "CLOXACILLIN_DDD", 
     "TRIM_SULFADOXINE_DDD", 
     "OXYTETRACYCLINE_DDD", 
     "AMPICILLIN_DDD", 
     "TILMICOSIN_DDD", 
     "BENZYLPENICILLIN_B_DDD", 
     "ENROFLOXACIN_DDD", 
     "DANOFLOXACIN_DDD", 
     "TULATHROMYCIN_DDD", 
     "GAMITROMYCIN_DDD", 
     "TILDIPIROSIN_DDD", 
     "MARBOFLOXACIN_DDD", 
     "SULFANILAMIDE_DDD", 
     "SULFATHIAZOLE_DDD", 
     "STREPTOMYCIN_SULF_DDD", 
     "SULFAMETHAZINE_DDD", 
     "TETRACYCLINE_DDD", 
     "NEOMYCIN_SULF_DDD", 
     "SULFAMERAZINE_DDD", 
     "SULFAGUANIDINE_DDD", 
     "SUCCINYLSULFATHIAZOLE_DDD",
     "FLORFENICOL_DDD"))

```
  
En compilant, **il y aura parfois des "retour de produits" un certaine année, sans achat dans cette catégorie, ce qui occasionnera des DDD et DCD négatives pour certaines ferme-année (1 ou 2 ferme-années dans le jeu de données de 85 troupeau et 4 années). À ce stade, nous avons décidé de les écarter.** À noter, cela arrive ici parce que nous sommes en produits compilés par molécule, par ferme, par année et par voie d'administration; il y a donc parfois très peu de produits dans une catégorie donnée. Plus loin, lorsqu'on compilera par ferme-année, ce sera moins problématique.  
  
Nombre de lignes négatives (sur 1685 lignes):  
- 17900 2 fermes 1 an  
- Cefa IU 1 ferme 1 an  
- Cefa IM-L 2 fermes 1 an  
- Oxytet Inj 2 fermes 1 an  
- Tulathro Inj 1 ferme  
- Gamithro Inj 1 ferme  
- Sulfa oral 1 ferme  
  
```{r}
Agg.amu.pos <- Agg.amu
Agg.amu.pos[Agg.amu.pos < 0] <- 0

```


Ensuite nous pouvons importer, puis lier la table contenant les inventaires 2017-2018 d'animaux. Pour la démonstration, nous assumerons que les inventaires sont demeurés constant jusqu'en 2020. Dans le futur, la jointure pourrait se faire par *No.ferme* **ET** *années*, si des inventaires par année deviennent disponibles.  
  
```{r}
inv <- read.csv(file="data/Fermes_Projet.csv", header=TRUE, sep=";", encoding="UTF-8")

myvars <- c("Num_ferme", "Nb_veau", "Nb_taure", "Nb_vch1", "Nb_vch2", "Nb_tarie", "Nb_taureau", "Quota", "Nb_VL", "nb_vch")
inv <- inv[myvars]

#Main merge
max.agg.amu <- merge(
  x = Agg.amu.pos,
  y = inv,
  by.x = "No.Ferme",
  by.y = "Num_ferme",
  all.x=TRUE
)

```
  

## Calcul des indices pour la table ferme-année-route et ferme-année 
Deux tables seront nécessaires pour les calculs. Une avec les données par ferme-année (qui servira pour la plupart des figures de base), une autre avec les données par ferme-année-route d'administration (pour l'explosion des données par voie d'administration). 


### Utilisation par ferme, année et voie d'administration
  
```{r}
#Totale
max.agg.amu$total_DCD <- apply(max.agg.amu[, 4:32],1, sum)
max.agg.amu$total_DDD <- apply(max.agg.amu[, 33:61],1, sum)

#Cat1
max.agg.amu$cat1_DCD <- max.agg.amu$CEFTIOFUR_DCD+max.agg.amu$POLYMYXINB_SULF_DCD+max.agg.amu$DANOFLOXACIN_DCD+max.agg.amu$ENROFLOXACIN_DCD+max.agg.amu$MARBOFLOXACIN_DCD
max.agg.amu$cat1_DDD <- max.agg.amu$CEFTIOFUR_DDD+max.agg.amu$POLYMYXINB_SULF_DDD+max.agg.amu$DANOFLOXACIN_DDD+max.agg.amu$ENROFLOXACIN_DDD+max.agg.amu$MARBOFLOXACIN_DDD 
  
#Cat2
max.agg.amu$cat2_DCD <- max.agg.amu$GAMITROMYCIN_DCD+max.agg.amu$TILDIPIROSIN_DCD+max.agg.amu$TILMICOSIN_DCD+max.agg.amu$TULATHROMYCIN_DCD+max.agg.amu$TYLOSIN_DCD+max.agg.amu$DIHYDROSTREPTOMYCIN_DCD+max.agg.amu$NEOMYCIN_SULF_DCD+max.agg.amu$STREPTOMYCIN_SULF_DCD+max.agg.amu$AMPICILLIN_DCD+max.agg.amu$CEFAPIRIN_DCD+max.agg.amu$PIRLIMYCIN_DCD+max.agg.amu$CLOXACILLIN_DCD+max.agg.amu$BENZYLPENICILLIN_P_DCD+max.agg.amu$BENZYLPENICILLIN_B_DCD+max.agg.amu$TRIM_SULFADOXINE_DCD

max.agg.amu$cat2_DDD <- max.agg.amu$GAMITROMYCIN_DDD+max.agg.amu$TILDIPIROSIN_DDD+max.agg.amu$TILMICOSIN_DDD+max.agg.amu$TULATHROMYCIN_DDD+max.agg.amu$TYLOSIN_DDD+max.agg.amu$DIHYDROSTREPTOMYCIN_DDD+max.agg.amu$NEOMYCIN_SULF_DDD+max.agg.amu$STREPTOMYCIN_SULF_DDD+max.agg.amu$AMPICILLIN_DDD+max.agg.amu$CEFAPIRIN_DDD+max.agg.amu$PIRLIMYCIN_DDD+max.agg.amu$CLOXACILLIN_DDD+max.agg.amu$BENZYLPENICILLIN_P_DDD+max.agg.amu$BENZYLPENICILLIN_B_DDD+max.agg.amu$TRIM_SULFADOXINE_DDD 
 
#Cat3
max.agg.amu$cat3_DCD <- max.agg.amu$CHLORTETRACYCLINE_DCD+max.agg.amu$OXYTETRACYCLINE_DCD+max.agg.amu$TETRACYCLINE_DCD+max.agg.amu$SUCCINYLSULFATHIAZOLE_DCD+max.agg.amu$SULFAGUANIDINE_DCD+max.agg.amu$SULFAMERAZINE_DCD+max.agg.amu$SULFAMETHAZINE_DCD+max.agg.amu$SULFANILAMIDE_DCD+max.agg.amu$SULFATHIAZOLE_DCD+max.agg.amu$FLORFENICOL_DCD

max.agg.amu$cat3_DDD <- max.agg.amu$CHLORTETRACYCLINE_DDD+max.agg.amu$OXYTETRACYCLINE_DDD+max.agg.amu$TETRACYCLINE_DDD+max.agg.amu$SUCCINYLSULFATHIAZOLE_DDD+max.agg.amu$SULFAGUANIDINE_DDD+max.agg.amu$SULFAMERAZINE_DDD+max.agg.amu$SULFAMETHAZINE_DDD+max.agg.amu$SULFANILAMIDE_DDD+max.agg.amu$SULFATHIAZOLE_DDD+max.agg.amu$FLORFENICOL_DCD 

#By family
#Penicillins with extended spectrum
max.agg.amu$PenES_DCD <- max.agg.amu$AMPICILLIN_DCD
max.agg.amu$PenES_DDD <- max.agg.amu$AMPICILLIN_DDD

#Beta-lactamase resistant penicillins
max.agg.amu$BLResPen_DCD <- max.agg.amu$CLOXACILLIN_DCD
max.agg.amu$BLResPen_DDD <- max.agg.amu$CLOXACILLIN_DDD

#Beta-lactamase sensitive penicillins
max.agg.amu$BLSensPen_DCD <- max.agg.amu$BENZYLPENICILLIN_P_DCD + max.agg.amu$BENZYLPENICILLIN_B_DCD
max.agg.amu$BLSensPen_DDD <- max.agg.amu$BENZYLPENICILLIN_P_DDD + max.agg.amu$BENZYLPENICILLIN_B_DDD

#First generation cephalosporin
max.agg.amu$FGCeph_DCD <- max.agg.amu$CEFAPIRIN_DCD
max.agg.amu$FGCeph_DDD <- max.agg.amu$CEFAPIRIN_DDD

#Third-generation cephalosporins
max.agg.amu$TGCeph_DCD <- max.agg.amu$CEFTIOFUR_DCD
max.agg.amu$TGCeph_DDD <- max.agg.amu$CEFTIOFUR_DDD

#Fluoroquinolones
max.agg.amu$Fluoro_DCD <- max.agg.amu$DANOFLOXACIN_DCD + max.agg.amu$ENROFLOXACIN_DCD + max.agg.amu$MARBOFLOXACIN_DCD
max.agg.amu$Fluoro_DDD <- max.agg.amu$DANOFLOXACIN_DDD + max.agg.amu$ENROFLOXACIN_DDD + max.agg.amu$MARBOFLOXACIN_DDD

#Amphenicols
max.agg.amu$Amph_DCD <- max.agg.amu$FLORFENICOL_DCD
max.agg.amu$Amph_DDD <- max.agg.amu$FLORFENICOL_DDD

#Macrolides
max.agg.amu$Macr_DCD <- max.agg.amu$GAMITROMYCIN_DCD + max.agg.amu$TILMICOSIN_DCD + max.agg.amu$TILDIPIROSIN_DCD + max.agg.amu$TYLOSIN_DCD + max.agg.amu$TULATHROMYCIN_DCD
max.agg.amu$Macr_DDD <- max.agg.amu$GAMITROMYCIN_DDD + max.agg.amu$TILMICOSIN_DDD + max.agg.amu$TILDIPIROSIN_DDD + max.agg.amu$TYLOSIN_DDD + max.agg.amu$TULATHROMYCIN_DDD

#Tetracyclines
max.agg.amu$Tetr_DCD <- max.agg.amu$CHLORTETRACYCLINE_DCD + max.agg.amu$OXYTETRACYCLINE_DCD + max.agg.amu$TETRACYCLINE_DCD
max.agg.amu$Tetr_DDD <- max.agg.amu$CHLORTETRACYCLINE_DDD + max.agg.amu$OXYTETRACYCLINE_DDD + max.agg.amu$TETRACYCLINE_DDD

#Aminoglycosides
max.agg.amu$Amin_DCD <- max.agg.amu$NEOMYCIN_SULF_DCD +  max.agg.amu$STREPTOMYCIN_SULF_DCD + max.agg.amu$DIHYDROSTREPTOMYCIN_DCD
max.agg.amu$Amin_DDD <- max.agg.amu$NEOMYCIN_SULF_DDD +  max.agg.amu$STREPTOMYCIN_SULF_DDD + max.agg.amu$DIHYDROSTREPTOMYCIN_DDD

#Sulfonamides
max.agg.amu$Sulf_DCD <- max.agg.amu$SULFANILAMIDE_DCD + max.agg.amu$SULFATHIAZOLE_DCD + max.agg.amu$SULFAMETHAZINE_DCD + max.agg.amu$SULFAMERAZINE_DCD + max.agg.amu$SULFAGUANIDINE_DCD + max.agg.amu$SUCCINYLSULFATHIAZOLE_DCD
max.agg.amu$Sulf_DDD <- max.agg.amu$SULFANILAMIDE_DDD + max.agg.amu$SULFATHIAZOLE_DDD + max.agg.amu$SULFAMETHAZINE_DDD + max.agg.amu$SULFAMERAZINE_DDD + max.agg.amu$SULFAGUANIDINE_DDD + max.agg.amu$SUCCINYLSULFATHIAZOLE_DDD

#Lincosamides
max.agg.amu$Linco_DCD <- max.agg.amu$PIRLIMYCIN_DCD
max.agg.amu$Linco_DDD <- max.agg.amu$PIRLIMYCIN_DDD

#Polymyxins
max.agg.amu$Poly_DCD <- max.agg.amu$POLYMYXINB_SULF_DCD
max.agg.amu$Poly_DDD <- max.agg.amu$POLYMYXINB_SULF_DDD

#TMS
max.agg.amu$TMS_DCD <- max.agg.amu$TRIM_SULFADOXINE_DCD
max.agg.amu$TMS_DDD <- max.agg.amu$TRIM_SULFADOXINE_DDD


```

**Standardization par 100 vaches-année**
Présentement, les indices sont en nombre absolus de DDDbovCA et DCDbovCA. Ces valeurs doivent être standardisées par unité de production pour pouvoir avoir des **taux d'utilisation**. Dans le futur (avec les ajouts de champs dans Vet Expert), ce pourra seulement être le nombre d'animaux de <24 mois, le nombre d'animaux de >24 mois, ou la somme des deux (i.e. nombre d'animaux total). **Pour le moment, je prendrais le nombre d'animaux total comme dénominateur.**
  
```{r}
#calculer le nombre total de vaches adultes
max.agg.amu$denom <- max.agg.amu$Nb_vch1+max.agg.amu$Nb_vch2+max.agg.amu$Nb_tarie

#Diviser les valeurs absolues par le nombre d'animaux
#DCD
max.agg.amu$TYLOSIN_DCD <- max.agg.amu$TYLOSIN_DCD/max.agg.amu$denom*100
max.agg.amu$CHLORTETRACYCLINE_DCD <- max.agg.amu$CHLORTETRACYCLINE_DCD/max.agg.amu$denom*100
max.agg.amu$BENZYLPENICILLIN_P_DCD <- max.agg.amu$BENZYLPENICILLIN_P_DCD/max.agg.amu$denom*100
max.agg.amu$DIHYDROSTREPTOMYCIN_DCD <- max.agg.amu$DIHYDROSTREPTOMYCIN_DCD/max.agg.amu$denom*100 
max.agg.amu$POLYMYXINB_SULF_DCD <- max.agg.amu$POLYMYXINB_SULF_DCD/max.agg.amu$denom*100
max.agg.amu$CEFAPIRIN_DCD <- max.agg.amu$CEFAPIRIN_DCD/max.agg.amu$denom*100
max.agg.amu$PIRLIMYCIN_DCD <- max.agg.amu$PIRLIMYCIN_DCD/max.agg.amu$denom*100
max.agg.amu$CEFTIOFUR_DCD <- max.agg.amu$CEFTIOFUR_DCD/max.agg.amu$denom*100
max.agg.amu$CLOXACILLIN_DCD <- max.agg.amu$CLOXACILLIN_DCD/max.agg.amu$denom*100
max.agg.amu$TRIM_SULFADOXINE_DCD <- max.agg.amu$TRIM_SULFADOXINE_DCD/max.agg.amu$denom*100
max.agg.amu$OXYTETRACYCLINE_DCD <- max.agg.amu$OXYTETRACYCLINE_DCD/max.agg.amu$denom*100
max.agg.amu$AMPICILLIN_DCD <- max.agg.amu$AMPICILLIN_DCD/max.agg.amu$denom*100
max.agg.amu$TILMICOSIN_DCD <- max.agg.amu$TILMICOSIN_DCD/max.agg.amu$denom*100
max.agg.amu$BENZYLPENICILLIN_B_DCD <- max.agg.amu$BENZYLPENICILLIN_B_DCD/max.agg.amu$denom*100
max.agg.amu$ENROFLOXACIN_DCD <- max.agg.amu$ENROFLOXACIN_DCD/max.agg.amu$denom*100
max.agg.amu$DANOFLOXACIN_DCD <- max.agg.amu$DANOFLOXACIN_DCD/max.agg.amu$denom*100
max.agg.amu$TULATHROMYCIN_DCD <- max.agg.amu$TULATHROMYCIN_DCD/max.agg.amu$denom*100
max.agg.amu$GAMITROMYCIN_DCD <- max.agg.amu$GAMITROMYCIN_DCD/max.agg.amu$denom*100
max.agg.amu$TILDIPIROSIN_DCD <- max.agg.amu$TILDIPIROSIN_DCD/max.agg.amu$denom*100
max.agg.amu$MARBOFLOXACIN_DCD <- max.agg.amu$MARBOFLOXACIN_DCD/max.agg.amu$denom*100
max.agg.amu$SULFANILAMIDE_DCD <- max.agg.amu$SULFANILAMIDE_DCD/max.agg.amu$denom*100
max.agg.amu$SULFATHIAZOLE_DCD <- max.agg.amu$SULFATHIAZOLE_DCD/max.agg.amu$denom*100
max.agg.amu$STREPTOMYCIN_SULF_DCD <- max.agg.amu$STREPTOMYCIN_SULF_DCD/max.agg.amu$denom*100
max.agg.amu$SULFAMETHAZINE_DCD <- max.agg.amu$SULFAMETHAZINE_DCD/max.agg.amu$denom*100
max.agg.amu$TETRACYCLINE_DCD <- max.agg.amu$TETRACYCLINE_DCD/max.agg.amu$denom*100
max.agg.amu$NEOMYCIN_SULF_DCD <- max.agg.amu$NEOMYCIN_SULF_DCD/max.agg.amu$denom*100
max.agg.amu$SULFAMERAZINE_DCD <- max.agg.amu$SULFAMERAZINE_DCD/max.agg.amu$denom*100
max.agg.amu$SULFAGUANIDINE_DCD <- max.agg.amu$SULFAGUANIDINE_DCD/max.agg.amu$denom*100
max.agg.amu$SUCCINYLSULFATHIAZOLE_DCD <- max.agg.amu$SUCCINYLSULFATHIAZOLE_DCD/max.agg.amu$denom*100
max.agg.amu$FLORFENICOL_DCD <- max.agg.amu$FLORFENICOL_DCD/max.agg.amu$denom*100

max.agg.amu$total_DCD <- max.agg.amu$total_DCD/max.agg.amu$denom*100
max.agg.amu$cat1_DCD <- max.agg.amu$cat1_DCD/max.agg.amu$denom*100
max.agg.amu$cat2_DCD <- max.agg.amu$cat2_DCD/max.agg.amu$denom*100
max.agg.amu$cat3_DCD <- max.agg.amu$cat3_DCD/max.agg.amu$denom*100

max.agg.amu$PenES_DCD <- max.agg.amu$PenES_DCD/max.agg.amu$denom*100
max.agg.amu$BLResPen_DCD <- max.agg.amu$BLResPen_DCD/max.agg.amu$denom*100
max.agg.amu$BLSensPen_DCD <- max.agg.amu$BLSensPen_DCD/max.agg.amu$denom*100
max.agg.amu$FGCeph_DCD <- max.agg.amu$FGCeph_DCD/max.agg.amu$denom*100
max.agg.amu$TGCeph_DCD <- max.agg.amu$TGCeph_DCD/max.agg.amu$denom*100
max.agg.amu$Fluoro_DCD <- max.agg.amu$Fluoro_DCD/max.agg.amu$denom*100
max.agg.amu$Amph_DCD <- max.agg.amu$Amph_DCD/max.agg.amu$denom*100
max.agg.amu$Macr_DCD <- max.agg.amu$Macr_DCD/max.agg.amu$denom*100
max.agg.amu$Tetr_DCD <- max.agg.amu$Tetr_DCD/max.agg.amu$denom*100
max.agg.amu$Amin_DCD <- max.agg.amu$Amin_DCD/max.agg.amu$denom*100
max.agg.amu$Sulf_DCD <- max.agg.amu$Sulf_DCD/max.agg.amu$denom*100
max.agg.amu$Linco_DCD <- max.agg.amu$Linco_DCD/max.agg.amu$denom*100
max.agg.amu$Poly_DCD <- max.agg.amu$Poly_DCD/max.agg.amu$denom*100
max.agg.amu$TMS_DCD <- max.agg.amu$TMS_DCD/max.agg.amu$denom*100

#DDD
max.agg.amu$TYLOSIN_DDD <- max.agg.amu$TYLOSIN_DDD/max.agg.amu$denom*100
max.agg.amu$CHLORTETRACYCLINE_DDD <- max.agg.amu$CHLORTETRACYCLINE_DDD/max.agg.amu$denom*100
max.agg.amu$BENZYLPENICILLIN_P_DDD <- max.agg.amu$BENZYLPENICILLIN_P_DDD/max.agg.amu$denom*100
max.agg.amu$DIHYDROSTREPTOMYCIN_DDD <- max.agg.amu$DIHYDROSTREPTOMYCIN_DDD/max.agg.amu$denom*100 
max.agg.amu$POLYMYXINB_SULF_DDD <- max.agg.amu$POLYMYXINB_SULF_DDD/max.agg.amu$denom*100
max.agg.amu$CEFAPIRIN_DDD <- max.agg.amu$CEFAPIRIN_DDD/max.agg.amu$denom*100
max.agg.amu$PIRLIMYCIN_DDD <- max.agg.amu$PIRLIMYCIN_DDD/max.agg.amu$denom*100
max.agg.amu$CEFTIOFUR_DDD <- max.agg.amu$CEFTIOFUR_DDD/max.agg.amu$denom*100
max.agg.amu$CLOXACILLIN_DDD <- max.agg.amu$CLOXACILLIN_DDD/max.agg.amu$denom*100
max.agg.amu$TRIM_SULFADOXINE_DDD <- max.agg.amu$TRIM_SULFADOXINE_DDD/max.agg.amu$denom*100
max.agg.amu$OXYTETRACYCLINE_DDD <- max.agg.amu$OXYTETRACYCLINE_DDD/max.agg.amu$denom*100
max.agg.amu$AMPICILLIN_DDD <- max.agg.amu$AMPICILLIN_DDD/max.agg.amu$denom*100
max.agg.amu$TILMICOSIN_DDD <- max.agg.amu$TILMICOSIN_DDD/max.agg.amu$denom*100
max.agg.amu$BENZYLPENICILLIN_B_DDD <- max.agg.amu$BENZYLPENICILLIN_B_DDD/max.agg.amu$denom*100
max.agg.amu$ENROFLOXACIN_DDD <- max.agg.amu$ENROFLOXACIN_DDD/max.agg.amu$denom*100
max.agg.amu$DANOFLOXACIN_DDD <- max.agg.amu$DANOFLOXACIN_DDD/max.agg.amu$denom*100
max.agg.amu$TULATHROMYCIN_DDD <- max.agg.amu$TULATHROMYCIN_DDD/max.agg.amu$denom*100
max.agg.amu$GAMITROMYCIN_DDD <- max.agg.amu$GAMITROMYCIN_DDD/max.agg.amu$denom*100
max.agg.amu$TILDIPIROSIN_DDD <- max.agg.amu$TILDIPIROSIN_DDD/max.agg.amu$denom*100
max.agg.amu$MARBOFLOXACIN_DDD <- max.agg.amu$MARBOFLOXACIN_DDD/max.agg.amu$denom*100
max.agg.amu$SULFANILAMIDE_DDD <- max.agg.amu$SULFANILAMIDE_DDD/max.agg.amu$denom*100
max.agg.amu$SULFATHIAZOLE_DDD <- max.agg.amu$SULFATHIAZOLE_DDD/max.agg.amu$denom*100
max.agg.amu$STREPTOMYCIN_SULF_DDD <- max.agg.amu$STREPTOMYCIN_SULF_DDD/max.agg.amu$denom*100
max.agg.amu$SULFAMETHAZINE_DDD <- max.agg.amu$SULFAMETHAZINE_DDD/max.agg.amu$denom*100
max.agg.amu$TETRACYCLINE_DDD <- max.agg.amu$TETRACYCLINE_DDD/max.agg.amu$denom*100
max.agg.amu$NEOMYCIN_SULF_DDD <- max.agg.amu$NEOMYCIN_SULF_DDD/max.agg.amu$denom*100
max.agg.amu$SULFAMERAZINE_DDD <- max.agg.amu$SULFAMERAZINE_DDD/max.agg.amu$denom*100
max.agg.amu$SULFAGUANIDINE_DDD <- max.agg.amu$SULFAGUANIDINE_DDD/max.agg.amu$denom*100
max.agg.amu$SUCCINYLSULFATHIAZOLE_DDD <- max.agg.amu$SUCCINYLSULFATHIAZOLE_DDD/max.agg.amu$denom*100
max.agg.amu$FLORFENICOL_DDD <- max.agg.amu$FLORFENICOL_DDD/max.agg.amu$denom*100

max.agg.amu$total_DDD <- max.agg.amu$total_DDD/max.agg.amu$denom*100
max.agg.amu$cat1_DDD <- max.agg.amu$cat1_DDD/max.agg.amu$denom*100
max.agg.amu$cat2_DDD <- max.agg.amu$cat2_DDD/max.agg.amu$denom*100
max.agg.amu$cat3_DDD <- max.agg.amu$cat3_DDD/max.agg.amu$denom*100

max.agg.amu$PenES_DDD <- max.agg.amu$PenES_DDD/max.agg.amu$denom*100
max.agg.amu$BLResPen_DDD <- max.agg.amu$BLResPen_DDD/max.agg.amu$denom*100
max.agg.amu$BLSensPen_DDD <- max.agg.amu$BLSensPen_DDD/max.agg.amu$denom*100
max.agg.amu$FGCeph_DDD <- max.agg.amu$FGCeph_DDD/max.agg.amu$denom*100
max.agg.amu$TGCeph_DDD <- max.agg.amu$TGCeph_DDD/max.agg.amu$denom*100
max.agg.amu$Fluoro_DDD <- max.agg.amu$Fluoro_DDD/max.agg.amu$denom*100
max.agg.amu$Amph_DDD <- max.agg.amu$Amph_DDD/max.agg.amu$denom*100
max.agg.amu$Macr_DDD <- max.agg.amu$Macr_DDD/max.agg.amu$denom*100
max.agg.amu$Tetr_DDD <- max.agg.amu$Tetr_DDD/max.agg.amu$denom*100
max.agg.amu$Amin_DDD <- max.agg.amu$Amin_DDD/max.agg.amu$denom*100
max.agg.amu$Sulf_DDD <- max.agg.amu$Sulf_DDD/max.agg.amu$denom*100
max.agg.amu$Linco_DDD <- max.agg.amu$Linco_DDD/max.agg.amu$denom*100
max.agg.amu$Poly_DDD <- max.agg.amu$Poly_DDD/max.agg.amu$denom*100
max.agg.amu$TMS_DDD <- max.agg.amu$TMS_DDD/max.agg.amu$denom*100
```
  
Avant de finaliser la table, je vais retirer les nombres d'animaux afin d'éviter tout recoupement qui pourrait mener à un bris de confidentialité. Puis j'enregistre la table.  
  
```{r}
max.agg.amu2 <- max.agg.amu[ -c(64:72, 109) ]

write.csv(max.agg.amu2,"Rapport_sectoriel - Appli Shiny/data/max.csv", row.names = FALSE)
```


### Utilisation par ferme-année

```{r}
#Then summarize by farm and year only. This will be the table with the minimum possibilities in term of exploding the data.
min.agg.amu <- setNames(
  aggregate(
    cbind(AMU$TYLOSIN_DCD, 
          AMU$CHLORTETRACYCLINE_DCD, 
          AMU$BENZYLPENICILLIN_P_DCD, 
          AMU$DIHYDROSTREPTOMYCIN_DCD, 
          AMU$POLYMYXINB_SULF_DCD, 
          AMU$CEFAPIRIN_DCD, 
          AMU$PIRLIMYCIN_DCD, 
          AMU$CEFTIOFUR_DCD, 
          AMU$CLOXACILLIN_DCD, 
          AMU$TRIM_SULFADOXINE_DCD, 
          AMU$OXYTETRACYCLINE_DCD, 
          AMU$AMPICILLIN_DCD, 
          AMU$TILMICOSIN_DCD, 
          AMU$BENZYLPENICILLIN_B_DCD, 
          AMU$ENROFLOXACIN_DCD, 
          AMU$DANOFLOXACIN_DCD, 
          AMU$TULATHROMYCIN_DCD, 
          AMU$GAMITROMYCIN_DCD, 
          AMU$TILDIPIROSIN_DCD, 
          AMU$MARBOFLOXACIN_DCD, 
          AMU$SULFANILAMIDE_DCD, 
          AMU$SULFATHIAZOLE_DCD, 
          AMU$STREPTOMYCIN_SULF_DCD, 
          AMU$SULFAMETHAZINE_DCD, 
          AMU$TETRACYCLINE_DCD, 
          AMU$NEOMYCIN_SULF_DCD, 
          AMU$SULFAMERAZINE_DCD, 
          AMU$SULFAGUANIDINE_DCD, 
          AMU$SUCCINYLSULFATHIAZOLE_DCD,
          AMU$FLORFENICOL_DCD,
         
          AMU$TYLOSIN_DDD, 
          AMU$CHLORTETRACYCLINE_DDD, 
          AMU$BENZYLPENICILLIN_P_DDD, 
          AMU$DIHYDROSTREPTOMYCIN_DDD, 
          AMU$POLYMYXINB_SULF_DDD, 
          AMU$CEFAPIRIN_DDD, 
          AMU$PIRLIMYCIN_DDD, 
          AMU$CEFTIOFUR_DDD, 
          AMU$CLOXACILLIN_DDD, 
          AMU$TRIM_SULFADOXINE_DDD, 
          AMU$OXYTETRACYCLINE_DDD, 
          AMU$AMPICILLIN_DDD, 
          AMU$TILMICOSIN_DDD, 
          AMU$BENZYLPENICILLIN_B_DDD, 
          AMU$ENROFLOXACIN_DDD, 
          AMU$DANOFLOXACIN_DDD, 
          AMU$TULATHROMYCIN_DDD, 
          AMU$GAMITROMYCIN_DDD, 
          AMU$TILDIPIROSIN_DDD, 
          AMU$MARBOFLOXACIN_DDD, 
          AMU$SULFANILAMIDE_DDD, 
          AMU$SULFATHIAZOLE_DDD, 
          AMU$STREPTOMYCIN_SULF_DDD, 
          AMU$SULFAMETHAZINE_DDD, 
          AMU$TETRACYCLINE_DDD, 
          AMU$NEOMYCIN_SULF_DDD, 
          AMU$SULFAMERAZINE_DDD, 
          AMU$SULFAGUANIDINE_DDD, 
          AMU$SUCCINYLSULFATHIAZOLE_DDD,
          AMU$FLORFENICOL_DDD), 
    by=list(AMU$Year, AMU$No.ferme), FUN=sum),
  c( "Year",
     "No.Ferme",
     "TYLOSIN_DCD",
     "CHLORTETRACYCLINE_DCD",
     "BENZYLPENICILLIN_P_DCD", 
     "DIHYDROSTREPTOMYCIN_DCD", 
     "POLYMYXINB_SULF_DCD", 
     "CEFAPIRIN_DCD", 
     "PIRLIMYCIN_DCD", 
     "CEFTIOFUR_DCD", 
     "CLOXACILLIN_DCD", 
     "TRIM_SULFADOXINE_DCD", 
     "OXYTETRACYCLINE_DCD", 
     "AMPICILLIN_DCD", 
     "TILMICOSIN_DCD", 
     "BENZYLPENICILLIN_B_DCD", 
     "ENROFLOXACIN_DCD", 
     "DANOFLOXACIN_DCD", 
     "TULATHROMYCIN_DCD", 
     "GAMITROMYCIN_DCD", 
     "TILDIPIROSIN_DCD", 
     "MARBOFLOXACIN_DCD", 
     "SULFANILAMIDE_DCD", 
     "SULFATHIAZOLE_DCD", 
     "STREPTOMYCIN_SULF_DCD", 
     "SULFAMETHAZINE_DCD", 
     "TETRACYCLINE_DCD", 
     "NEOMYCIN_SULF_DCD", 
     "SULFAMERAZINE_DCD", 
     "SULFAGUANIDINE_DCD", 
     "SUCCINYLSULFATHIAZOLE_DCD",
     "FLORFENICOL_DCD",
     
     "TYLOSIN_DDD",
     "CHLORTETRACYCLINE_DDD",
     "BENZYLPENICILLIN_P_DDD", 
     "DIHYDROSTREPTOMYCIN_DDD", 
     "POLYMYXINB_SULF_DDD", 
     "CEFAPIRIN_DDD", 
     "PIRLIMYCIN_DDD", 
     "CEFTIOFUR_DDD", 
     "CLOXACILLIN_DDD", 
     "TRIM_SULFADOXINE_DDD", 
     "OXYTETRACYCLINE_DDD", 
     "AMPICILLIN_DDD", 
     "TILMICOSIN_DDD", 
     "BENZYLPENICILLIN_B_DDD", 
     "ENROFLOXACIN_DDD", 
     "DANOFLOXACIN_DDD", 
     "TULATHROMYCIN_DDD", 
     "GAMITROMYCIN_DDD", 
     "TILDIPIROSIN_DDD", 
     "MARBOFLOXACIN_DDD", 
     "SULFANILAMIDE_DDD", 
     "SULFATHIAZOLE_DDD", 
     "STREPTOMYCIN_SULF_DDD", 
     "SULFAMETHAZINE_DDD", 
     "TETRACYCLINE_DDD", 
     "NEOMYCIN_SULF_DDD", 
     "SULFAMERAZINE_DDD", 
     "SULFAGUANIDINE_DDD", 
     "SUCCINYLSULFATHIAZOLE_DDD",
     "FLORFENICOL_DDD"))

min.agg.amu.pos <- min.agg.amu
min.agg.amu.pos[min.agg.amu.pos < 0] <- 0

#Main merge
min.agg.amu <- merge(
  x = min.agg.amu.pos,
  y = inv,
  by.x = "No.Ferme",
  by.y = "Num_ferme",
  all.x=TRUE
)

#Totale
min.agg.amu$total_DCD <- apply(min.agg.amu[, 4:32],1, sum)
min.agg.amu$total_DDD <- apply(min.agg.amu[, 33:61],1, sum)

#Cat1
min.agg.amu$cat1_DCD <- min.agg.amu$CEFTIOFUR_DCD+min.agg.amu$POLYMYXINB_SULF_DCD+min.agg.amu$DANOFLOXACIN_DCD+min.agg.amu$ENROFLOXACIN_DCD+min.agg.amu$MARBOFLOXACIN_DCD
min.agg.amu$cat1_DDD <- min.agg.amu$CEFTIOFUR_DDD+min.agg.amu$POLYMYXINB_SULF_DDD+min.agg.amu$DANOFLOXACIN_DDD+min.agg.amu$ENROFLOXACIN_DDD+min.agg.amu$MARBOFLOXACIN_DDD 
  
#Cat2
min.agg.amu$cat2_DCD <- min.agg.amu$GAMITROMYCIN_DCD+min.agg.amu$TILDIPIROSIN_DCD+min.agg.amu$TILMICOSIN_DCD+min.agg.amu$TULATHROMYCIN_DCD+min.agg.amu$TYLOSIN_DCD+min.agg.amu$DIHYDROSTREPTOMYCIN_DCD+min.agg.amu$NEOMYCIN_SULF_DCD+min.agg.amu$STREPTOMYCIN_SULF_DCD+min.agg.amu$AMPICILLIN_DCD+min.agg.amu$CEFAPIRIN_DCD+min.agg.amu$PIRLIMYCIN_DCD+min.agg.amu$CLOXACILLIN_DCD+min.agg.amu$BENZYLPENICILLIN_P_DCD+min.agg.amu$BENZYLPENICILLIN_B_DCD+min.agg.amu$TRIM_SULFADOXINE_DCD

min.agg.amu$cat2_DDD <- min.agg.amu$GAMITROMYCIN_DDD+min.agg.amu$TILDIPIROSIN_DDD+min.agg.amu$TILMICOSIN_DDD+min.agg.amu$TULATHROMYCIN_DDD+min.agg.amu$TYLOSIN_DDD+min.agg.amu$DIHYDROSTREPTOMYCIN_DDD+min.agg.amu$NEOMYCIN_SULF_DDD+min.agg.amu$STREPTOMYCIN_SULF_DDD+min.agg.amu$AMPICILLIN_DDD+min.agg.amu$CEFAPIRIN_DDD+min.agg.amu$PIRLIMYCIN_DDD+min.agg.amu$CLOXACILLIN_DDD+min.agg.amu$BENZYLPENICILLIN_P_DDD+min.agg.amu$BENZYLPENICILLIN_B_DDD+min.agg.amu$TRIM_SULFADOXINE_DDD 
 
#Cat3
min.agg.amu$cat3_DCD <- min.agg.amu$CHLORTETRACYCLINE_DCD+min.agg.amu$OXYTETRACYCLINE_DCD+min.agg.amu$TETRACYCLINE_DCD+min.agg.amu$SUCCINYLSULFATHIAZOLE_DCD+min.agg.amu$SULFAGUANIDINE_DCD+min.agg.amu$SULFAMERAZINE_DCD+min.agg.amu$SULFAMETHAZINE_DCD+min.agg.amu$SULFANILAMIDE_DCD+min.agg.amu$SULFATHIAZOLE_DCD+min.agg.amu$FLORFENICOL_DCD

min.agg.amu$cat3_DDD <- min.agg.amu$CHLORTETRACYCLINE_DDD+min.agg.amu$OXYTETRACYCLINE_DDD+min.agg.amu$TETRACYCLINE_DDD+min.agg.amu$SUCCINYLSULFATHIAZOLE_DDD+min.agg.amu$SULFAGUANIDINE_DDD+min.agg.amu$SULFAMERAZINE_DDD+min.agg.amu$SULFAMETHAZINE_DDD+min.agg.amu$SULFANILAMIDE_DDD+min.agg.amu$SULFATHIAZOLE_DDD+min.agg.amu$FLORFENICOL_DDD 

#By family
#Penicillins with extended spectrum
min.agg.amu$PenES_DCD <- min.agg.amu$AMPICILLIN_DCD
min.agg.amu$PenES_DDD <- min.agg.amu$AMPICILLIN_DDD

#Beta-lactamase resistant penicillins
min.agg.amu$BLResPen_DCD <- min.agg.amu$CLOXACILLIN_DCD
min.agg.amu$BLResPen_DDD <- min.agg.amu$CLOXACILLIN_DDD

#Beta-lactamase sensitive penicillins
min.agg.amu$BLSensPen_DCD <- min.agg.amu$BENZYLPENICILLIN_P_DCD + min.agg.amu$BENZYLPENICILLIN_B_DCD
min.agg.amu$BLSensPen_DDD <- min.agg.amu$BENZYLPENICILLIN_P_DDD + min.agg.amu$BENZYLPENICILLIN_B_DDD

#First generation cephalosporin
min.agg.amu$FGCeph_DCD <- min.agg.amu$CEFAPIRIN_DCD
min.agg.amu$FGCeph_DDD <- min.agg.amu$CEFAPIRIN_DDD

#Third-generation cephalosporins
min.agg.amu$TGCeph_DCD <- min.agg.amu$CEFTIOFUR_DCD
min.agg.amu$TGCeph_DDD <- min.agg.amu$CEFTIOFUR_DDD

#Fluoroquinolones
min.agg.amu$Fluoro_DCD <- min.agg.amu$DANOFLOXACIN_DCD + min.agg.amu$ENROFLOXACIN_DCD + min.agg.amu$MARBOFLOXACIN_DCD
min.agg.amu$Fluoro_DDD <- min.agg.amu$DANOFLOXACIN_DDD + min.agg.amu$ENROFLOXACIN_DDD + min.agg.amu$MARBOFLOXACIN_DDD

#Amphenicols
min.agg.amu$Amph_DCD <- min.agg.amu$FLORFENICOL_DCD
min.agg.amu$Amph_DDD <- min.agg.amu$FLORFENICOL_DDD

#Macrolides
min.agg.amu$Macr_DCD <- min.agg.amu$GAMITROMYCIN_DCD + min.agg.amu$TILMICOSIN_DCD + min.agg.amu$TILDIPIROSIN_DCD + min.agg.amu$TYLOSIN_DCD + min.agg.amu$TULATHROMYCIN_DCD
min.agg.amu$Macr_DDD <- min.agg.amu$GAMITROMYCIN_DDD + min.agg.amu$TILMICOSIN_DDD + min.agg.amu$TILDIPIROSIN_DDD + min.agg.amu$TYLOSIN_DDD + min.agg.amu$TULATHROMYCIN_DDD

#Tetracyclines
min.agg.amu$Tetr_DCD <- min.agg.amu$CHLORTETRACYCLINE_DCD + min.agg.amu$OXYTETRACYCLINE_DCD + min.agg.amu$TETRACYCLINE_DCD
min.agg.amu$Tetr_DDD <- min.agg.amu$CHLORTETRACYCLINE_DDD + min.agg.amu$OXYTETRACYCLINE_DDD + min.agg.amu$TETRACYCLINE_DDD

#Aminoglycosides
min.agg.amu$Amin_DCD <- min.agg.amu$NEOMYCIN_SULF_DCD +  min.agg.amu$STREPTOMYCIN_SULF_DCD + min.agg.amu$DIHYDROSTREPTOMYCIN_DCD
min.agg.amu$Amin_DDD <- min.agg.amu$NEOMYCIN_SULF_DDD +  min.agg.amu$STREPTOMYCIN_SULF_DDD + min.agg.amu$DIHYDROSTREPTOMYCIN_DDD

#Sulfonamides
min.agg.amu$Sulf_DCD <- min.agg.amu$SULFANILAMIDE_DCD + min.agg.amu$SULFATHIAZOLE_DCD + min.agg.amu$SULFAMETHAZINE_DCD + min.agg.amu$SULFAMERAZINE_DCD + min.agg.amu$SULFAGUANIDINE_DCD + min.agg.amu$SUCCINYLSULFATHIAZOLE_DCD
min.agg.amu$Sulf_DDD <- min.agg.amu$SULFANILAMIDE_DDD + min.agg.amu$SULFATHIAZOLE_DDD + min.agg.amu$SULFAMETHAZINE_DDD + min.agg.amu$SULFAMERAZINE_DDD + min.agg.amu$SULFAGUANIDINE_DDD + min.agg.amu$SUCCINYLSULFATHIAZOLE_DDD

#Lincosamides
min.agg.amu$Linco_DCD <- min.agg.amu$PIRLIMYCIN_DCD
min.agg.amu$Linco_DDD <- min.agg.amu$PIRLIMYCIN_DDD

#Polymyxins
min.agg.amu$Poly_DCD <- min.agg.amu$POLYMYXINB_SULF_DCD
min.agg.amu$Poly_DDD <- min.agg.amu$POLYMYXINB_SULF_DDD

#TMS
min.agg.amu$TMS_DCD <- min.agg.amu$TRIM_SULFADOXINE_DCD
min.agg.amu$TMS_DDD <- min.agg.amu$TRIM_SULFADOXINE_DDD


#calculer le nombre total d'animaux
min.agg.amu$denom <- min.agg.amu$Nb_vch1+min.agg.amu$Nb_vch2+min.agg.amu$Nb_tarie

#Diviser les valeurs absolues par le nombre d'animaux
#DCD
min.agg.amu$TYLOSIN_DCD <- min.agg.amu$TYLOSIN_DCD/min.agg.amu$denom*100
min.agg.amu$CHLORTETRACYCLINE_DCD <- min.agg.amu$CHLORTETRACYCLINE_DCD/min.agg.amu$denom*100
min.agg.amu$BENZYLPENICILLIN_P_DCD <- min.agg.amu$BENZYLPENICILLIN_P_DCD/min.agg.amu$denom*100
min.agg.amu$DIHYDROSTREPTOMYCIN_DCD <- min.agg.amu$DIHYDROSTREPTOMYCIN_DCD/min.agg.amu$denom*100 
min.agg.amu$POLYMYXINB_SULF_DCD <- min.agg.amu$POLYMYXINB_SULF_DCD/min.agg.amu$denom*100
min.agg.amu$CEFAPIRIN_DCD <- min.agg.amu$CEFAPIRIN_DCD/min.agg.amu$denom*100
min.agg.amu$PIRLIMYCIN_DCD <- min.agg.amu$PIRLIMYCIN_DCD/min.agg.amu$denom*100
min.agg.amu$CEFTIOFUR_DCD <- min.agg.amu$CEFTIOFUR_DCD/min.agg.amu$denom*100
min.agg.amu$CLOXACILLIN_DCD <- min.agg.amu$CLOXACILLIN_DCD/min.agg.amu$denom*100
min.agg.amu$TRIM_SULFADOXINE_DCD <- min.agg.amu$TRIM_SULFADOXINE_DCD/min.agg.amu$denom*100
min.agg.amu$OXYTETRACYCLINE_DCD <- min.agg.amu$OXYTETRACYCLINE_DCD/min.agg.amu$denom*100
min.agg.amu$AMPICILLIN_DCD <- min.agg.amu$AMPICILLIN_DCD/min.agg.amu$denom*100
min.agg.amu$TILMICOSIN_DCD <- min.agg.amu$TILMICOSIN_DCD/min.agg.amu$denom*100
min.agg.amu$BENZYLPENICILLIN_B_DCD <- min.agg.amu$BENZYLPENICILLIN_B_DCD/min.agg.amu$denom*100
min.agg.amu$ENROFLOXACIN_DCD <- min.agg.amu$ENROFLOXACIN_DCD/min.agg.amu$denom*100
min.agg.amu$DANOFLOXACIN_DCD <- min.agg.amu$DANOFLOXACIN_DCD/min.agg.amu$denom*100
min.agg.amu$TULATHROMYCIN_DCD <- min.agg.amu$TULATHROMYCIN_DCD/min.agg.amu$denom*100
min.agg.amu$GAMITROMYCIN_DCD <- min.agg.amu$GAMITROMYCIN_DCD/min.agg.amu$denom*100
min.agg.amu$TILDIPIROSIN_DCD <- min.agg.amu$TILDIPIROSIN_DCD/min.agg.amu$denom*100
min.agg.amu$MARBOFLOXACIN_DCD <- min.agg.amu$MARBOFLOXACIN_DCD/min.agg.amu$denom*100
min.agg.amu$SULFANILAMIDE_DCD <- min.agg.amu$SULFANILAMIDE_DCD/min.agg.amu$denom*100
min.agg.amu$SULFATHIAZOLE_DCD <- min.agg.amu$SULFATHIAZOLE_DCD/min.agg.amu$denom*100
min.agg.amu$STREPTOMYCIN_SULF_DCD <- min.agg.amu$STREPTOMYCIN_SULF_DCD/min.agg.amu$denom*100
min.agg.amu$SULFAMETHAZINE_DCD <- min.agg.amu$SULFAMETHAZINE_DCD/min.agg.amu$denom*100
min.agg.amu$TETRACYCLINE_DCD <- min.agg.amu$TETRACYCLINE_DCD/min.agg.amu$denom*100
min.agg.amu$NEOMYCIN_SULF_DCD <- min.agg.amu$NEOMYCIN_SULF_DCD/min.agg.amu$denom*100
min.agg.amu$SULFAMERAZINE_DCD <- min.agg.amu$SULFAMERAZINE_DCD/min.agg.amu$denom*100
min.agg.amu$SULFAGUANIDINE_DCD <- min.agg.amu$SULFAGUANIDINE_DCD/min.agg.amu$denom*100
min.agg.amu$FLORFENICOL_DCD <- min.agg.amu$FLORFENICOL_DCD/min.agg.amu$denom*100

min.agg.amu$total_DCD <- min.agg.amu$total_DCD/min.agg.amu$denom*100
min.agg.amu$cat1_DCD <- min.agg.amu$cat1_DCD/min.agg.amu$denom*100
min.agg.amu$cat2_DCD <- min.agg.amu$cat2_DCD/min.agg.amu$denom*100
min.agg.amu$cat3_DCD <- min.agg.amu$cat3_DCD/min.agg.amu$denom*100

min.agg.amu$PenES_DCD <- min.agg.amu$PenES_DCD/min.agg.amu$denom*100
min.agg.amu$BLResPen_DCD <- min.agg.amu$BLResPen_DCD/min.agg.amu$denom*100
min.agg.amu$BLSensPen_DCD <- min.agg.amu$BLSensPen_DCD/min.agg.amu$denom*100
min.agg.amu$FGCeph_DCD <- min.agg.amu$FGCeph_DCD/min.agg.amu$denom*100
min.agg.amu$TGCeph_DCD <- min.agg.amu$TGCeph_DCD/min.agg.amu$denom*100
min.agg.amu$Fluoro_DCD <- min.agg.amu$Fluoro_DCD/min.agg.amu$denom*100
min.agg.amu$Amph_DCD <- min.agg.amu$Amph_DCD/min.agg.amu$denom*100
min.agg.amu$Macr_DCD <- min.agg.amu$Macr_DCD/min.agg.amu$denom*100
min.agg.amu$Tetr_DCD <- min.agg.amu$Tetr_DCD/min.agg.amu$denom*100
min.agg.amu$Amin_DCD <- min.agg.amu$Amin_DCD/min.agg.amu$denom*100
min.agg.amu$Sulf_DCD <- min.agg.amu$Sulf_DCD/min.agg.amu$denom*100
min.agg.amu$Linco_DCD <- min.agg.amu$Linco_DCD/min.agg.amu$denom*100
min.agg.amu$Poly_DCD <- min.agg.amu$Poly_DCD/min.agg.amu$denom*100
min.agg.amu$TMS_DCD <- min.agg.amu$TMS_DCD/min.agg.amu$denom*100



#DDD
min.agg.amu$TYLOSIN_DDD <- min.agg.amu$TYLOSIN_DDD/min.agg.amu$denom*100
min.agg.amu$CHLORTETRACYCLINE_DDD <- min.agg.amu$CHLORTETRACYCLINE_DDD/min.agg.amu$denom*100
min.agg.amu$BENZYLPENICILLIN_P_DDD <- min.agg.amu$BENZYLPENICILLIN_P_DDD/min.agg.amu$denom*100
min.agg.amu$DIHYDROSTREPTOMYCIN_DDD <- min.agg.amu$DIHYDROSTREPTOMYCIN_DDD/min.agg.amu$denom*100 
min.agg.amu$POLYMYXINB_SULF_DDD <- min.agg.amu$POLYMYXINB_SULF_DDD/min.agg.amu$denom*100
min.agg.amu$CEFAPIRIN_DDD <- min.agg.amu$CEFAPIRIN_DDD/min.agg.amu$denom*100
min.agg.amu$PIRLIMYCIN_DDD <- min.agg.amu$PIRLIMYCIN_DDD/min.agg.amu$denom*100
min.agg.amu$CEFTIOFUR_DDD <- min.agg.amu$CEFTIOFUR_DDD/min.agg.amu$denom*100
min.agg.amu$CLOXACILLIN_DDD <- min.agg.amu$CLOXACILLIN_DDD/min.agg.amu$denom*100
min.agg.amu$TRIM_SULFADOXINE_DDD <- min.agg.amu$TRIM_SULFADOXINE_DDD/min.agg.amu$denom*100
min.agg.amu$OXYTETRACYCLINE_DDD <- min.agg.amu$OXYTETRACYCLINE_DDD/min.agg.amu$denom*100
min.agg.amu$AMPICILLIN_DDD <- min.agg.amu$AMPICILLIN_DDD/min.agg.amu$denom*100
min.agg.amu$TILMICOSIN_DDD <- min.agg.amu$TILMICOSIN_DDD/min.agg.amu$denom*100
min.agg.amu$BENZYLPENICILLIN_B_DDD <- min.agg.amu$BENZYLPENICILLIN_B_DDD/min.agg.amu$denom*100
min.agg.amu$ENROFLOXACIN_DDD <- min.agg.amu$ENROFLOXACIN_DDD/min.agg.amu$denom*100
min.agg.amu$DANOFLOXACIN_DDD <- min.agg.amu$DANOFLOXACIN_DDD/min.agg.amu$denom*100
min.agg.amu$TULATHROMYCIN_DDD <- min.agg.amu$TULATHROMYCIN_DDD/min.agg.amu$denom*100
min.agg.amu$GAMITROMYCIN_DDD <- min.agg.amu$GAMITROMYCIN_DDD/min.agg.amu$denom*100
min.agg.amu$TILDIPIROSIN_DDD <- min.agg.amu$TILDIPIROSIN_DDD/min.agg.amu$denom*100
min.agg.amu$MARBOFLOXACIN_DDD <- min.agg.amu$MARBOFLOXACIN_DDD/min.agg.amu$denom*100
min.agg.amu$SULFANILAMIDE_DDD <- min.agg.amu$SULFANILAMIDE_DDD/min.agg.amu$denom*100
min.agg.amu$SULFATHIAZOLE_DDD <- min.agg.amu$SULFATHIAZOLE_DDD/min.agg.amu$denom*100
min.agg.amu$STREPTOMYCIN_SULF_DDD <- min.agg.amu$STREPTOMYCIN_SULF_DDD/min.agg.amu$denom*100
min.agg.amu$SULFAMETHAZINE_DDD <- min.agg.amu$SULFAMETHAZINE_DDD/min.agg.amu$denom*100
min.agg.amu$TETRACYCLINE_DDD <- min.agg.amu$TETRACYCLINE_DDD/min.agg.amu$denom*100
min.agg.amu$NEOMYCIN_SULF_DDD <- min.agg.amu$NEOMYCIN_SULF_DDD/min.agg.amu$denom*100
min.agg.amu$SULFAMERAZINE_DDD <- min.agg.amu$SULFAMERAZINE_DDD/min.agg.amu$denom*100
min.agg.amu$SULFAGUANIDINE_DDD <- min.agg.amu$SULFAGUANIDINE_DDD/min.agg.amu$denom*100
min.agg.amu$FLORFENICOL_DDD <- min.agg.amu$FLORFENICOL_DDD/min.agg.amu$denom*100

min.agg.amu$total_DDD <- min.agg.amu$total_DDD/min.agg.amu$denom*100
min.agg.amu$cat1_DDD <- min.agg.amu$cat1_DDD/min.agg.amu$denom*100
min.agg.amu$cat2_DDD <- min.agg.amu$cat2_DDD/min.agg.amu$denom*100
min.agg.amu$cat3_DDD <- min.agg.amu$cat3_DDD/min.agg.amu$denom*100

min.agg.amu$PenES_DDD <- min.agg.amu$PenES_DDD/min.agg.amu$denom*100
min.agg.amu$BLResPen_DDD <- min.agg.amu$BLResPen_DDD/min.agg.amu$denom*100
min.agg.amu$BLSensPen_DDD <- min.agg.amu$BLSensPen_DDD/min.agg.amu$denom*100
min.agg.amu$FGCeph_DDD <- min.agg.amu$FGCeph_DDD/min.agg.amu$denom*100
min.agg.amu$TGCeph_DDD <- min.agg.amu$TGCeph_DDD/min.agg.amu$denom*100
min.agg.amu$Fluoro_DDD <- min.agg.amu$Fluoro_DDD/min.agg.amu$denom*100
min.agg.amu$Amph_DDD <- min.agg.amu$Amph_DDD/min.agg.amu$denom*100
min.agg.amu$Macr_DDD <- min.agg.amu$Macr_DDD/min.agg.amu$denom*100
min.agg.amu$Tetr_DDD <- min.agg.amu$Tetr_DDD/min.agg.amu$denom*100
min.agg.amu$Amin_DDD <- min.agg.amu$Amin_DDD/min.agg.amu$denom*100
min.agg.amu$Sulf_DDD <- min.agg.amu$Sulf_DDD/min.agg.amu$denom*100
min.agg.amu$Linco_DDD <- min.agg.amu$Linco_DDD/min.agg.amu$denom*100
min.agg.amu$Poly_DDD <- min.agg.amu$Poly_DDD/min.agg.amu$denom*100
min.agg.amu$TMS_DDD <- min.agg.amu$TMS_DDD/min.agg.amu$denom*100



min.agg.amu2 <- min.agg.amu[ -c(63:71, 108) ]

write.csv(min.agg.amu2,"Rapport_sectoriel - Appli Shiny/data/min.csv", row.names = FALSE)

```

## Prescriptions alimentaires
Nous devons également importer et manipuler/organiser les données de prescriptions qui ont aussi été extraites du logiciel Vet-Expert. Dans ce cas, nous n'avons que des données 2019-2020-2021-2022. Nous n'allons pas "créer" de fausses-données 2016-2017-2018 pour cette partie du prototype, je vais plutôt décaler les données.   
  
```{r}
library(readxl)

PA <- read_xlsx(path=("data/PRESCRIPTIONS alim.xlsx"), col_names = TRUE)

```
  
Une première étape est de retirer les prescriptions de type "annuelle" qui se retrouveront également dans les données de ventes, afin de ne conserver que les prescriptions alimentaires.  
  
```{r}
PA2 <- subset(PA, Type=="Aliment")
```

Il y a 180 prescriptions alimentaires dans le chiffrier. Ensuite, on pourrait extraire l'année (i.e., 2016, 2017, 2018...) des champs "date de début" et date de fin". Ainsi, toutes les prescriptions qui sont actives dans une (ou plusieurs) années seront compilées dans celle(s)-ci.  
  
```{r}
PA2$Year1 <- substr(PA2$`Date de Début`, 1, 4)
PA2$Year2 <- substr(PA2$`Date de Fin`, 1, 4)
```
  
Nous pouvons maintenant vérifier les types de prescriptions par ferme pour une certaine année. Seulement trois "types" de prescriptions ont été faites sur 37 fermes seulement: Oxytetracycline, Lasalocide Sodique et Monensin.   
  
```{r}
library(data.table)
library(dplyr)
library(tidyverse)

PA2$nim <- PA2$`Nim Client`
PA2$Item <- PA2$`Nom Item`

#Compile users per Item for beginning of year
data <- dcast(PA2, nim+Year1 ~ Item, value.var="Item")

#Rename the Items
data$Oxytet <- data$`chlorhydrate d'oxytetracycline 1000g/kg/néomycin 325`
data$Monensin <- data$`monensin sodique 20%`+data$`Prémélange Rumensin Shur-Gain renfermant 2 g de monensin par Kg de Prémélange`+data$Rumensin+data$RUMENSIN+
  data$`Rumensin (200 g monensin par kg)`+data$`RUMENSIN (200 g/kg sodium momensin)`+data$`Rumensin 20%`+data$`RUMENSIN contenant 200 g/kg`+data$`RUMENSIN PREMIX`+
  data$`Rumensin Premix 0.2%`+data$`Rumensin renfermant 200g de monensin par Kg de Rumensin`+data$`Sodium de Monensin ou Rumensin`+data$`Sodium De Monensin ou Rumensin`
data$Lasalocid <- data$Deccox+data$DECCOX+data$`Deccox 6% Prémélange 25 kg`+data$`DECCOX 6% PREMELANGE 25kg`+data$`Decoquinate ou Deccox`+data$`LASALOCIDE SODIQUE`
data$Year <- data$Year1
alim1 <-  data[ c(1, 23:26 ) ]

#Compile users per Item for end of year
data <- dcast(PA2, nim+Year2 ~ Item, value.var="Item")

#Rename the Items
data$Oxytet <- data$`chlorhydrate d'oxytetracycline 1000g/kg/néomycin 325`
data$Monensin <- data$`monensin sodique 20%`+data$`Prémélange Rumensin Shur-Gain renfermant 2 g de monensin par Kg de Prémélange`+data$Rumensin+data$RUMENSIN+
  data$`Rumensin (200 g monensin par kg)`+data$`RUMENSIN (200 g/kg sodium momensin)`+data$`Rumensin 20%`+data$`RUMENSIN contenant 200 g/kg`+data$`RUMENSIN PREMIX`+
  data$`Rumensin Premix 0.2%`+data$`Rumensin renfermant 200g de monensin par Kg de Rumensin`+data$`Sodium de Monensin ou Rumensin`+data$`Sodium De Monensin ou Rumensin`
data$Lasalocid <- data$Deccox+data$DECCOX+data$`Deccox 6% Prémélange 25 kg`+data$`DECCOX 6% PREMELANGE 25kg`+data$`Decoquinate ou Deccox`+data$`LASALOCIDE SODIQUE`
data$Year <- data$Year2
alim2 <-  data[ c(1, 23:26 ) ]

#Join the 2 datasets
alim <- rbind(alim1, alim2)

#summarize by farm and year
alim_B <- alim %>%
  aggregate(cbind(Oxytet, Lasalocid, Monensin) ~ nim+Year, sum)

#Replace 1, 2, 3, 4 by 0 and 1
alim_B$Oxytet <- ifelse(alim_B$Oxytet<1, 0, 1)
alim_B$Lasalocid <- ifelse(alim_B$Lasalocid<1, 0, 1)
alim_B$Monensin <- ifelse(alim_B$Monensin<1, 0, 1)

#summarize by year the number of users
alim_C <- alim_B %>%
  aggregate(cbind(Oxytet, Lasalocid, Monensin) ~ Year, sum)


alim_C <- alim_C %>% 
  rename(
    Oxytétracyclines = Oxytet,
    `Lasalocide sodique` = Lasalocid,
    Année = Year
    )

#Diviser par 84 fermes pour avoir un %
alim_C$Oxytétracyclines <- round(alim_C$Oxytétracyclines/84*100, digits=1)
alim_C$`Lasalocide sodique` <- round(alim_C$`Lasalocide sodique`/84*100, digits=1)
alim_C$Monensin <- round(alim_C$Monensin/84*100, digits=1)

ALIM <- data.frame(t(alim_C)) 


ALIM <- ALIM[-c(1),  ]

names <- c( "Oxytétracyclines", "Lasalocide sodique", "Monensin")

ALIM <- cbind(names, ALIM)



ALIM <- ALIM %>% 
  rename(
    Antibiotique = names,
    "Année 2017" = X1,
    "Année 2018" = X2,
    "Année 2019" = X3,
    "Année 2020" = X4
    )
#Add names as part of the table



ALIM

write.csv(ALIM,"Rapport_sectoriel - Appli Shiny/data/Alim.csv", row.names = FALSE)

```





